<script type="text/javascript">
  var gk_isXlsx = false;
  var gk_xlsxFileLookup = {};
  var gk_fileData = {};
  function filledCell(cell) {
    return cell !== "" && cell != null;
  }
  function loadFileData(filename) {
    if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
      try {
        var workbook = XLSX.read(gk_fileData[filename], { type: "base64" });
        var firstSheetName = workbook.SheetNames[0];
        var worksheet = workbook.Sheets[firstSheetName];

        // Convert sheet to JSON to filter blank rows
        var jsonData = XLSX.utils.sheet_to_json(worksheet, {
          header: 1,
          blankrows: false,
          defval: "",
        });
        // Filter out blank rows (rows where all cells are empty, null, or undefined)
        var filteredData = jsonData.filter((row) => row.some(filledCell));

        // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
        var headerRowIndex = filteredData.findIndex(
          (row, index) =>
            row.filter(filledCell).length >=
            filteredData[index + 1]?.filter(filledCell).length
        );
        // Fallback
        if (headerRowIndex === -1 || headerRowIndex > 25) {
          headerRowIndex = 0;
        }

        // Convert filtered JSON back to CSV
        var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
        csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
        return csv;
      } catch (e) {
        console.error(e);
        return "";
      }
    }
    return gk_fileData[filename] || "";
  }
</script>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resume Ranking Results</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f8f9fa;
        padding-top: 20px;
        padding-bottom: 20px;
      }
      .container {
        max-width: 900px;
      }
      h1 {
        margin-bottom: 20px;
        color: #0d6efd;
      }
      .table-responsive {
        margin-top: 20px;
      }
      .table th,
      .table td {
        white-space: normal; /* Allow text wrapping */
        word-wrap: break-word;
      }
      .job-desc-box {
        background-color: #e9ecef;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #0d6efd;
        white-space: pre-wrap;
        font-size: 0.9em;
        max-height: 200px;
        overflow-y: auto;
      }
      .match-keyword {
        display: inline-block;
        background-color: #d1e7dd; /* Light green for match */
        color: #0f5132;
        padding: 4px 8px;
        border-radius: 4px;
        margin-right: 5px;
        margin-bottom: 5px;
        font-size: 0.85em;
        font-weight: 600;
        cursor: help;
      }
      .similarity-score {
        font-weight: bold;
        color: #dc3545; /* Red for high visibility */
      }
      .back-link {
        margin-top: 20px;
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="container bg-white shadow rounded-lg p-4">
      <h1 class="text-center">Resume Ranking Results</h1>

      <h2 class="h5 mb-2 mt-4 text-secondary">Job Description Snippet:</h2>
      <div class="job-desc-box mb-4">
        {{ job_desc | truncate(500) }}
      </div>

      <h2 class="h5 mb-3 text-primary">
        Top {{ top_resumes | length }} Candidates
      </h2>
      <div class="table-responsive">
        <table class="table table-striped table-hover rounded-3">
          <thead>
            <tr>
              <th scope="col">Rank</th>
              <th scope="col">Resume ID/Filename</th>
              <th scope="col">
                <span data-bs-toggle="tooltip" title="SBERT Cosine Similarity">Similarity Score</span>
              </th>
              <th scope="col">Email ID</th>
              <th scope="col">
                <span data-bs-toggle="tooltip" title="Top terms found in both JD and Resume">Key Matches</span>
              </th>
            </tr>
          </thead>
          <tbody>
            {% for resume in top_resumes %}
            <tr>
              <th scope="row">{{ loop.index }}</th>
              <td>{{ resume.ID }}</td>
              <td>
                <span class="similarity-score">{{ resume.similarity | round(4) }}</span>
              </td>
              <td>{{ resume.email }}</td>
              <td>
                {% for match in resume.key_matches.split(', ') %}
                <span class="match-keyword">{{ match | replace('_', ' ') }}</span>
                {% endfor %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <a
        href="{{ url_for('main.download_file', filename=csv_filename) }}"
        class="btn btn-success fw-bold me-3 mt-3"
        >Download Full CSV Results</a
      >
      <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary mt-3 back-link"
        >Back to Home</a
      >
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize tooltips (for the table headers)
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    </script>
  </body>
</html>
